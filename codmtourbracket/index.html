<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CoDM Tournament Dashboard (Full Export)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        body { background-color: #0f172a; color: #e2e8f0; font-family: sans-serif; }
        .card { background-color: #1e293b; border: 1px solid #334155; transition: all 0.2s; }
        .card:hover { transform: translateY(-3px); border-color: #f59e0b; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5); }
        
        input[type="file"]::file-selector-button {
            margin-right: 16px; padding: 8px 16px; border-radius: 6px; border: none;
            background-color: #3b82f6; color: white; cursor: pointer; font-weight: bold; transition: background .2s;
        }
        input[type="file"]::file-selector-button:hover { background-color: #2563eb; }
        
        .mercenary-badge {
            background: linear-gradient(45deg, #10b981, #059669);
            color: white; font-size: 0.6rem; padding: 2px 6px; border-radius: 4px; text-transform: uppercase; letter-spacing: 1px;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        <header class="mb-8 text-center">
            <h1 class="text-3xl md:text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-yellow-400 to-orange-500 mb-2">
                CoDM TOURNAMENT
            </h1>
            <p class="text-gray-400">Dashboard Admin & Export System</p>
        </header>

        <div class="bg-gray-800 p-6 rounded-xl mb-8 shadow-2xl border border-gray-700">
            <h2 class="text-xl font-bold mb-4 text-white">üìÇ Upload & Proses Data</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-gray-900 p-4 rounded-lg border border-gray-600">
                    <label class="block text-yellow-400 font-bold mb-2">1. File Data Tim (Squad)</label>
                    <input type="file" id="fileTeams" accept=".csv" class="block w-full text-sm text-gray-400">
                </div>
                <div class="bg-gray-900 p-4 rounded-lg border border-gray-600">
                    <label class="block text-green-400 font-bold mb-2">2. File Data Solo (Opsional)</label>
                    <input type="file" id="fileSolo" accept=".csv" class="block w-full text-sm text-gray-400">
                </div>
            </div>
            
            <div class="mt-6">
                <button onclick="processFiles()" id="btnProcess" class="bg-blue-600 hover:bg-blue-500 text-white px-6 py-3 rounded-lg font-bold transition w-full shadow-lg">
                    üöÄ PROSES DATA
                </button>
            </div>
            
            <div id="actionButtons" class="hidden mt-6 pt-6 border-t border-gray-700 grid grid-cols-1 md:grid-cols-2 gap-4">
                <button id="btnSolo" onclick="convertSoloToTeams()" class="bg-gray-700 text-gray-400 px-6 py-4 rounded-lg font-bold transition border border-gray-600 cursor-not-allowed opacity-50" disabled>
                    ‚öîÔ∏è Gabung Solo ke Tim (Kosong)
                </button>
                <button onclick="randomizeBR()" class="bg-gradient-to-r from-yellow-600 to-orange-600 hover:from-yellow-500 hover:to-orange-500 text-white px-6 py-4 rounded-lg font-bold transition shadow-lg transform hover:scale-[1.02]">
                    üé≤ ACAK & TAMPILKAN GRUP BR
                </button>
            </div>
        </div>

        <div id="teamListSection" class="hidden mb-12">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-end border-b border-gray-700 pb-4 mb-4 gap-4">
                <div>
                    <h2 class="text-2xl font-bold text-white">üìã Daftar Peserta Terdaftar</h2>
                    <span id="totalTeamsLabel" class="text-sm text-yellow-400 font-bold"></span>
                </div>
                
                <div class="flex flex-wrap gap-2">
                    <button onclick="exportToCSV()" class="bg-green-700 hover:bg-green-600 text-white px-4 py-2 rounded text-sm font-bold flex items-center gap-2 transition shadow">
                        üì• Excel/CSV
                    </button>
                    <button onclick="downloadTeamListImage()" id="btnDownloadTeamImg" class="bg-indigo-600 hover:bg-indigo-500 text-white px-4 py-2 rounded text-sm font-bold flex items-center gap-2 transition shadow">
                        üì∏ Simpan Gambar
                    </button>
                </div>
            </div>
            
            <div id="teamListCaptureArea" class="bg-[#0f172a] p-4 -m-4 rounded-lg">
                <div id="teamListContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
                    </div>
            </div>
        </div>

        <div id="brSection" class="hidden mb-12">
            <div class="flex flex-wrap justify-between items-center mb-4 border-b border-gray-700 pb-2 gap-4">
                <h2 class="text-2xl font-bold text-yellow-400">üî• Hasil Pembagian Grup BR</h2>
                
                <button onclick="downloadBRImage()" id="btnDownloadBRImg" class="bg-orange-600 hover:bg-orange-500 text-white px-4 py-2 rounded text-sm font-bold flex items-center gap-2 shadow-lg">
                    üì∏ Simpan Gambar BR
                </button>
            </div>

            <div id="brContainer" class="bg-[#0f172a] p-4 -m-4 rounded-lg"> 
                <div id="brGrid" class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    </div>
            </div>
        </div>

    </div>

    <script>
        let rawTeams = [];
        let rawSolo = [];
        let isSoloMerged = false;

        // --- CORE FUNCTIONS ---
        function processFiles() {
            const fileTeams = document.getElementById('fileTeams').files[0];
            const fileSolo = document.getElementById('fileSolo').files[0];
            const btn = document.getElementById('btnProcess');

            rawTeams = []; rawSolo = []; isSoloMerged = false;

            if (!fileTeams) { alert("‚ùå Wajib upload File Teams dulu!"); return; }

            btn.innerText = "Membaca..."; btn.disabled = true;

            Papa.parse(fileTeams, {
                header: true, skipEmptyLines: true,
                complete: function(results) {
                    rawTeams = results.data.filter(r => r['Nama Tim'] && r['Nama Tim'].trim() !== "");
                    if (fileSolo) {
                        Papa.parse(fileSolo, {
                            header: true, skipEmptyLines: true,
                            complete: function(soloResults) {
                                rawSolo = soloResults.data.filter(r => r['Nickname']);
                                finishLoading();
                            }
                        });
                    } else { finishLoading(); }
                }
            });
        }

        function finishLoading() {
            renderTeamList(rawTeams);
            document.getElementById('teamListSection').classList.remove('hidden');
            document.getElementById('actionButtons').classList.remove('hidden');
            const btnSolo = document.getElementById('btnSolo');

            if(rawSolo.length > 0) {
                btnSolo.disabled = false;
                btnSolo.classList.remove('bg-gray-700', 'text-gray-400', 'cursor-not-allowed', 'opacity-50');
                btnSolo.classList.add('bg-green-600', 'text-white', 'hover:bg-green-500');
                btnSolo.innerHTML = `‚öîÔ∏è Gabung ${rawSolo.length} Player Solo`;
            } else {
                btnSolo.innerHTML = "‚öîÔ∏è Tidak ada Data Solo";
            }
            document.getElementById('btnProcess').innerText = "üöÄ PROSES ULANG";
            document.getElementById('btnProcess').disabled = false;
        }

        function convertSoloToTeams() {
            if(isSoloMerged || rawSolo.length === 0) return;
            let shuffledSolo = [...rawSolo].sort(() => 0.5 - Math.random());
            const teamSize = 5; 
            let newMercenaryTeams = [];
            let counter = 1;

            for (let i = 0; i < shuffledSolo.length; i += teamSize) {
                const chunk = shuffledSolo.slice(i, i + teamSize);
                let virtualTeam = {
                    'Nama Tim': `Mercenary Team ${counter}`,
                    'No WA': chunk[0]['No WA'] || '-',
                    'Logo URL': 'MERCENARY_LOGO',
                    'IsMercenary': true
                };
                chunk.forEach((player, idx) => {
                    let pNum = idx + 1;
                    virtualTeam[`Nick P${pNum}`] = player['Nickname'];
                    virtualTeam[`UID P${pNum}`] = player['UID'];
                    virtualTeam[`OpenID P${pNum}`] = player['OpenID'];
                });
                newMercenaryTeams.push(virtualTeam);
                counter++;
            }
            rawTeams = [...rawTeams, ...newMercenaryTeams];
            isSoloMerged = true;
            renderTeamList(rawTeams);
            
            const btnSolo = document.getElementById('btnSolo');
            btnSolo.disabled = true;
            btnSolo.innerHTML = "‚úÖ SUKSES DIGABUNGKAN";
            btnSolo.classList.add('opacity-50', 'cursor-not-allowed');
            alert(`Berhasil membuat ${newMercenaryTeams.length} Tim Mercenary!`);
        }

        function renderTeamList(teams) {
            const container = document.getElementById('teamListContainer');
            document.getElementById('totalTeamsLabel').innerText = `Total: ${teams.length} Tim`;
            container.innerHTML = "";

            teams.forEach(team => {
                let playersHtml = "";
                for(let i=1; i<=5; i++) {
                    if(team[`Nick P${i}`]) {
                        playersHtml += `<tr class="border-b border-gray-700/50"><td class="py-1 text-gray-300 truncate max-w-[80px]">${team[`Nick P${i}`]}</td><td class="font-mono text-blue-400 text-xs">${team[`UID P${i}`] || '-'}</td></tr>`;
                    }
                }
                let badgeHtml = team.IsMercenary ? `<span class="mercenary-badge ml-2">SOLO SQUAD</span>` : "";
                let logoContent = (team['Logo URL'] && team['Logo URL'].length > 5 && !team.IsMercenary) ? `<img src="${team['Logo URL']}" class="w-full h-full object-cover">` : '<span class="text-2xl">üõ°Ô∏è</span>';
                if(team.IsMercenary) logoContent = '<span class="text-2xl">‚öîÔ∏è</span>';

                container.innerHTML += `
                    <div class="card p-4 rounded-xl shadow-lg relative overflow-hidden ${team.IsMercenary ? 'border-green-500/50' : 'border-gray-600'}">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="w-12 h-12 bg-gray-900 rounded-full flex items-center justify-center overflow-hidden border border-gray-500 shadow-inner shrink-0">${logoContent}</div>
                            <div class="overflow-hidden"><div class="flex items-center"><h3 class="font-bold text-lg text-white truncate">${team['Nama Tim']}</h3>${badgeHtml}</div><p class="text-xs text-gray-500 flex items-center gap-1">üìû ${team['No WA'] || '-'}</p></div>
                        </div>
                        <div class="bg-gray-900/50 rounded-lg p-2"><table class="w-full text-xs text-left"><thead class="text-gray-500 font-semibold"><tr><th>Nick</th><th>UID</th></tr></thead><tbody>${playersHtml}</tbody></table></div>
                    </div>`;
            });
        }

        function randomizeBR() {
            if(rawTeams.length === 0) { alert("‚ùå Belum ada data tim!"); return; }
            if(rawSolo.length > 0 && !isSoloMerged) {
                if(!confirm("‚ö†Ô∏è Data Solo belum digabung. Mereka tidak akan masuk pembagian grup. Lanjut?")) return;
            }

            let shuffled = [...rawTeams].sort(() => 0.5 - Math.random());
            const perLobby = 25; 
            const lobbyCount = Math.ceil(shuffled.length / perLobby);
            
            const container = document.getElementById('brGrid'); 
            container.innerHTML = "";
            document.getElementById('brSection').classList.remove('hidden');
            
            for(let i=0; i < lobbyCount; i++) {
                const lobbyTeams = shuffled.slice(i * perLobby, (i + 1) * perLobby);
                let rows = "";
                lobbyTeams.forEach((t, idx) => {
                    let nameClass = t.IsMercenary ? "text-green-400 italic" : "text-gray-200 font-medium";
                    rows += `<tr class="border-b border-gray-700/50"><td class="py-2 px-3 font-bold text-yellow-500 text-center w-10">${idx + 1}</td><td class="py-2 px-3 ${nameClass}">${t['Nama Tim']}</td><td class="py-2 px-3 text-xs text-gray-500 font-mono text-right">${t['No WA']}</td></tr>`;
                });

                container.innerHTML += `
                    <div class="bg-gray-800 rounded-xl overflow-hidden border border-gray-600 shadow-2xl">
                        <div class="bg-gradient-to-r from-red-900 to-gray-800 p-3 flex justify-between items-center border-b border-red-700">
                            <h3 class="text-xl font-bold text-white tracking-wider">LOBBY ${String.fromCharCode(65 + i)}</h3>
                            <span class="text-xs bg-black/40 px-2 py-1 rounded text-red-200 border border-red-500/30">${lobbyTeams.length} / ${perLobby} Tim</span>
                        </div>
                        <div class="p-2 bg-gray-900"><table class="w-full text-sm"><thead class="text-gray-400 uppercase text-xs"><tr><th class="py-2 px-3">#</th><th class="text-left px-3">Nama Tim</th><th class="text-right px-3">Kontak</th></tr></thead><tbody>${rows}</tbody></table></div>
                    </div>`;
            }
            document.getElementById('brSection').scrollIntoView({ behavior: 'smooth' });
        }

        // --- EXPORT FUNCTIONS ---

        // 1. Export Gambar: DAFTAR PESERTA (NEW)
        function downloadTeamListImage() {
            const btn = document.getElementById('btnDownloadTeamImg');
            const originalText = btn.innerHTML;
            const element = document.getElementById("teamListCaptureArea"); 

            btn.innerHTML = "‚è≥ Memproses..."; btn.disabled = true;

            html2canvas(element, { backgroundColor: "#0f172a", scale: 2, useCORS: true }).then(canvas => {
                let link = document.createElement('a');
                link.download = `Daftar_Peserta_CoDM_${new Date().getTime()}.png`;
                link.href = canvas.toDataURL("image/png");
                link.click();
                btn.innerHTML = originalText; btn.disabled = false;
                alert("‚úÖ Gambar Daftar Peserta tersimpan!");
            }).catch(err => {
                console.error(err); alert("‚ùå Gagal. Coba lagi.");
                btn.innerHTML = originalText; btn.disabled = false;
            });
        }

        // 2. Export Gambar: HASIL BR
        function downloadBRImage() {
            const btn = document.getElementById('btnDownloadBRImg');
            const originalText = btn.innerHTML;
            const element = document.getElementById("brContainer"); 

            btn.innerHTML = "‚è≥ Memproses..."; btn.disabled = true;

            html2canvas(element, { backgroundColor: "#0f172a", scale: 2, useCORS: true }).then(canvas => {
                let link = document.createElement('a');
                link.download = `Hasil_Grup_BR_${new Date().getTime()}.png`;
                link.href = canvas.toDataURL("image/png");
                link.click();
                btn.innerHTML = originalText; btn.disabled = false;
                alert("‚úÖ Gambar Grup BR tersimpan!");
            }).catch(err => {
                console.error(err); alert("‚ùå Gagal. Coba lagi.");
                btn.innerHTML = originalText; btn.disabled = false;
            });
        }

        // 3. Export CSV (Backup Data)
        function exportToCSV() {
            if(rawTeams.length === 0) { alert("Data masih kosong!"); return; }
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "Nama Tim,No WA,IsSoloSquad,Nick P1,UID P1,Nick P2,UID P2,Nick P3,UID P3,Nick P4,UID P4,Nick P5,UID P5\n";

            rawTeams.forEach(t => {
                let row = [`"${t['Nama Tim']}"`,`"${t['No WA']}"`, t.IsMercenary ? "YA" : "TIDAK"];
                for(let i=1; i<=5; i++) { row.push(`"${t[`Nick P${i}`] || ''}"`); row.push(`"${t[`UID P${i}`] || ''}"`); }
                csvContent += row.join(",") + "\n";
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `Backup_Peserta_Final_${new Date().getTime()}.csv`);
            document.body.appendChild(link); link.click(); document.body.removeChild(link);
        }
    </script>
</body>
</html>
