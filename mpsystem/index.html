<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bravta12 - Live Bracket</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCb71qnIjcHA9hBe20AHhQIX4xGlzgYk_Q",
            authDomain: "bravta-tournament.firebaseapp.com",
            databaseURL: "https://bravta-tournament-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "bravta-tournament",
            storageBucket: "bravta-tournament.firebasestorage.app",
            messagingSenderId: "215927889474",
            appId: "1:215927889474:web:d8e898e1f6ec08c95597db"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        window.saveTournament = (data) => set(ref(db, 'currentTournament'), data);
        
        onValue(ref(db, 'currentTournament'), (snapshot) => {
            const data = snapshot.val();
            if (data) window.loadFromFirebase(data);
        });
    </script>

    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>

    <style>
        :root {
            --bg-dark: #191919;      /* Background Challonge style */
            --match-bg: #2d2d2d;     /* Kotak abu-abu */
            --match-border: #444;    /* Border kotak */
            --ice-cyan: #00f3ff;     /* Warna aksen kita */
            --text-color: #e2e8f0;
            --line-color: #666;      /* Warna garis penghubung */
            
            /* --- UKURAN KUNCI (Compact Mode) --- */
            --card-height: 50px;     /* Tinggi kotak diperkecil */
            --card-width: 200px;     /* Lebar kotak */
            --base-gap: 20px;        /* Jarak dasar antar kotak di Round 1 */
        }

        body {
            background-color: var(--bg-dark);
            color: var(--text-color);
            font-family: 'Rajdhani', sans-serif;
            margin: 0; padding: 0;
            width: 100vw; height: 100vh;
            overflow: hidden; /* Container dalam yang akan scroll */
        }

        /* Container Utama yang bisa di-scroll */
        .viewport {
            width: 100%; height: 100%;
            overflow: auto; /* Scroll bar muncul otomatis jika konten besar */
            padding: 40px;
            box-sizing: border-box;
            background-image: radial-gradient(circle at 50% 50%, #222 0%, #191919 100%);
        }

        /* Wadah Pohon Turnamen */
        .tournament-tree {
            display: flex;
            flex-direction: row;
            width: fit-content; /* Lebar mengikuti konten */
            min-height: 100%;   /* Minimal setinggi layar */
            /* PENTING: Jangan align-items center, biarkan flow dari atas */
        }

        /* Kolom Per Ronde */
        .round {
            display: flex;
            flex-direction: column;
            width: var(--card-width);
            margin-right: 60px; /* Jarak horizontal untuk garis */
            /* margin-top dan gap akan diatur oleh JS agar presisi */
        }

        .round-title {
            text-align: center; color: #888; 
            font-weight: bold; text-transform: uppercase; letter-spacing: 1px;
            font-size: 0.9rem; margin-bottom: 20px;
            border-bottom: 2px solid #333; padding-bottom: 5px;
            height: 30px; /* Tinggi header fix */
        }

        /* --- KOTAK MATCH --- */
        .match {
            background-color: var(--match-bg);
            border: 1px solid var(--match-border);
            border-radius: 4px;
            height: var(--card-height);
            display: flex; flex-direction: column; justify-content: center;
            position: relative;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            transition: all 0.2s;
            z-index: 2; /* Di atas garis */
        }

        .match.clickable:hover {
            border-color: var(--ice-cyan);
            background-color: #383838;
            cursor: pointer;
        }

        .team { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 0 10px; font-size: 0.85rem; line-height: 1.2;
        }
        
        .team-name { 
            font-weight: 500; color: #ccc; max-width: 140px; 
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; 
        }
        
        .team-score { 
            font-family: monospace; font-weight: bold; color: #fbbf24; 
            background: #222; padding: 0 5px; border-radius: 3px; 
            min-width: 20px; text-align: center; font-size: 0.8rem;
        }

        .winner .team-name { color: var(--ice-cyan); font-weight: bold; }
        .winner .team-score { background: var(--ice-cyan); color: #000; }
        .winner-row { background: rgba(0, 243, 255, 0.05); }

        /* --- GARIS PENGHUBUNG (CSS MAGIC) --- */
        /* Menggunakan Pseudo-elements pada .match */

        /* Garis Keluar (Kanan) - Semua match kecuali Final */
        .match.has-next::before {
            content: ''; position: absolute;
            right: -30px; top: 50%;
            width: 30px; height: 2px;
            background: var(--line-color);
            z-index: 1;
        }

        /* Garis Vertikal (Siku) */
        /* Tim Atas (Genap): Garis turun ke bawah */
        .match.connect-down::after {
            content: ''; position: absolute;
            right: -30px; top: 50%;
            width: 2px; 
            /* Tinggi dihitung lewat variabel CSS di JS */
            height: var(--line-height); 
            background: var(--line-color);
            z-index: 1;
        }

        /* Tim Bawah (Ganjil): Garis naik ke atas */
        .match.connect-up::after {
            content: ''; position: absolute;
            right: -30px; bottom: 50%;
            width: 2px; 
            height: var(--line-height);
            background: var(--line-color);
            z-index: 1;
        }

        /* UI Components */
        .cyber-btn {
            background: #222; color: #ccc; border: 1px solid #444;
            padding: 6px 12px; border-radius: 4px; text-transform: uppercase; 
            font-weight: bold; transition: 0.2s; font-size: 0.75rem;
        }
        .cyber-btn:hover { border-color: var(--ice-cyan); color: var(--ice-cyan); background: #333; }
        
        .modal-bg { background: rgba(0,0,0,0.85); backdrop-filter: blur(3px); }
        .admin-only { display: none !important; }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 10px; height: 10px; }
        ::-webkit-scrollbar-track { background: #191919; }
        ::-webkit-scrollbar-thumb { background: #444; border-radius: 5px; }
        ::-webkit-scrollbar-thumb:hover { background: #666; }

    </style>
</head>
<body>

    <div class="fixed top-0 left-0 w-full z-50 bg-[#191919] border-b border-[#333] px-6 py-3 shadow-md flex justify-between items-center h-16">
        <div class="flex items-center gap-4">
            <h1 class="text-xl font-bold text-white tracking-wider">BRAVTA <span class="text-[#00f3ff]">BRACKET</span></h1>
            <div class="flex items-center gap-2 bg-[#222] px-3 py-1 rounded-full border border-[#333]">
                <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                <p class="text-[10px] text-gray-400 font-mono">LIVE</p>
            </div>
        </div>
        <div class="flex gap-2">
            <div id="adminControls" class="admin-only flex gap-2">
                <button onclick="openSetupModal()" class="cyber-btn"><i class="fas fa-tools mr-2"></i> SETUP</button>
            </div>
            <button onclick="enableAdminMode()" id="btnAdminLogin" class="cyber-btn"><i class="fas fa-lock mr-2"></i> ADMIN</button>
        </div>
    </div>

    <div class="viewport mt-16"> <div id="bracketContainer" class="tournament-tree">
            <div class="text-center m-auto text-gray-500 mt-20">
                <i class="fas fa-satellite-dish text-3xl mb-2 opacity-50"></i>
                <p class="font-mono text-sm">Waiting for Data...</p>
            </div>
        </div>
    </div>

    <div id="setupModal" class="fixed inset-0 modal-bg hidden z-50 flex items-center justify-center p-4">
        <div class="bg-[#222] border border-[#444] p-6 rounded shadow-2xl w-full max-w-sm">
            <h2 class="text-lg font-bold text-white mb-4 border-b border-[#444] pb-2">TOURNAMENT SETUP</h2>
            
            <label class="block text-xs text-gray-400 mb-1 uppercase font-bold">Size</label>
            <select id="teamCount" class="w-full bg-[#111] text-white border border-[#444] rounded p-2 mb-3 text-sm focus:border-[#00f3ff] outline-none">
                <option value="4">4 Teams</option>
                <option value="8" selected>8 Teams</option>
                <option value="16">16 Teams</option>
            </select>

            <label class="block text-xs text-gray-400 mb-1 uppercase font-bold">Teams (1/line)</label>
            <textarea id="teamNamesInput" rows="8" class="w-full bg-[#111] text-white border border-[#444] rounded p-2 text-sm focus:border-[#00f3ff] outline-none" placeholder="Team A&#10;Team B..."></textarea>
            
            <div class="flex justify-end gap-2 mt-4">
                <button onclick="closeModal('setupModal')" class="cyber-btn border-transparent hover:bg-[#333]">Cancel</button>
                <button onclick="generateAndSave()" class="cyber-btn border-blue-600 text-blue-400 hover:bg-blue-900/30">Create</button>
            </div>
        </div>
    </div>

    <div id="scoreModal" class="fixed inset-0 modal-bg hidden z-50 flex items-center justify-center p-4">
        <div class="bg-[#222] border border-orange-500/50 p-6 rounded shadow-2xl w-full max-w-xs">
            <h2 class="text-lg font-bold text-white mb-1">MATCH RESULT</h2>
            <p class="text-[10px] text-gray-500 mb-4 tracking-widest uppercase match-id-display">ID: 01</p>

            <div class="space-y-3">
                <div class="flex justify-between items-center bg-[#111] p-2 rounded border border-[#333]">
                    <span id="scoreTeamA" class="font-bold text-gray-300 text-sm truncate w-24">Team A</span>
                    <input type="number" id="inputScoreA" class="w-12 bg-[#222] border border-[#444] text-center text-white font-bold rounded p-1 outline-none" value="0">
                </div>
                <div class="flex justify-between items-center bg-[#111] p-2 rounded border border-[#333]">
                    <span id="scoreTeamB" class="font-bold text-gray-300 text-sm truncate w-24">Team B</span>
                    <input type="number" id="inputScoreB" class="w-12 bg-[#222] border border-[#444] text-center text-white font-bold rounded p-1 outline-none" value="0">
                </div>
            </div>

            <div class="flex justify-end gap-2 mt-4">
                <button onclick="closeModal('scoreModal')" class="cyber-btn border-transparent hover:bg-[#333]">Cancel</button>
                <button onclick="submitScore()" class="cyber-btn border-green-600 text-green-400 hover:bg-green-900/30">Update</button>
            </div>
        </div>
    </div>

    <script>
        // --- LOGIC UTAMA ---
        let localData = null;
        let isAdmin = false;
        let selectedRoundIdx = -1;
        let selectedMatchIdx = -1;

        // --- AUTH ---
        function enableAdminMode() {
            const pass = prompt("Admin Password:");
            if(pass === "admin123") { 
                isAdmin = true;
                document.getElementById('adminControls').classList.remove('admin-only');
                document.getElementById('btnAdminLogin').classList.add('hidden');
                if(localData) renderBracket(localData);
            } else { alert("Wrong Password"); }
        }

        window.loadFromFirebase = (data) => { localData = data; renderBracket(data); };

        // --- RENDERER PRESISI (MATH BASED) ---
        function renderBracket(data) {
            const container = document.getElementById('bracketContainer');
            container.innerHTML = '';
            if(!data || !data.rounds) return;

            const roundNames = ["Round of 16", "Quarter Final", "Semi Final", "Grand Final", "Champion"];
            let startIndex = roundNames.length - data.rounds.length - 1;

            // KONSTANTA UKURAN (Harus sama dengan CSS)
            const CARD_H = 50; 
            const BASE_GAP = 20;

            data.rounds.forEach((round, rIndex) => {
                const roundDiv = document.createElement('div');
                roundDiv.className = 'round';
                
                // HEADER
                const title = document.createElement('div');
                title.className = 'round-title';
                title.innerText = roundNames[startIndex + rIndex] || `Round ${rIndex+1}`;
                roundDiv.appendChild(title);

                // --- KALKULASI JARAK PRESISI ---
                // Jarak antar pusat kartu harus berlipat ganda setiap ronde
                // Round 0: Gap = 20. Distance = 50 + 20 = 70.
                // Round 1: Distance = 140. Gap = 140 - 50 = 90.
                // Round 2: Distance = 280. Gap = 280 - 50 = 230.
                
                const centerDistance = (CARD_H + BASE_GAP) * Math.pow(2, rIndex);
                const currentGap = centerDistance - CARD_H;
                
                // Offset Awal (Padding Top) untuk kotak pertama agar lurus dengan connector sebelumnya
                // Round 0: 0.
                // Round 1: Perlu turun setengah dari (distance R0) = 35px? 
                // Rumus offset: (CenterDistance / 2) - (OriginalSpacing / 2) ?
                // Rumus simpel: PaddingTop akumulatif.
                
                // Kita gunakan Gap antar elemen Flexbox
                roundDiv.style.gap = `${currentGap}px`;
                
                // Padding Top khusus elemen pertama agar sejajar tengah
                // Padding = (CenterDistance / 2) - (CARD_H / 2) - (Judul/Margin?)
                // Cara termudah: PaddingTop = (currentGap - BASE_GAP) / 2
                // R0: (20-20)/2 = 0.
                // R1: (90-20)/2 = 35.
                // R2: (230-20)/2 = 105.
                const paddingTop = (currentGap - BASE_GAP) / 2;
                // Kita terapkan margin-top pada elemen match pertama saja
                
                const isFinal = rIndex === data.rounds.length - 1;

                round.forEach((match, mIndex) => {
                    const matchDiv = document.createElement('div');
                    
                    // Style dasar
                    let cursorClass = isAdmin ? "clickable" : "";
                    matchDiv.className = `match ${cursorClass}`;
                    if(isAdmin) matchDiv.onclick = () => openScoreModal(rIndex, mIndex);

                    // Margin top untuk match pertama
                    if (mIndex === 0) {
                        matchDiv.style.marginTop = `${paddingTop}px`;
                    }

                    // --- LOGIKA GARIS ---
                    if (!isFinal) {
                        matchDiv.classList.add('has-next'); // Garis horizontal keluar
                        
                        // Hitung tinggi garis siku
                        // Tinggi garis = Jarak ke tengah pair / 2
                        // Jarak ke tengah pair = centerDistance
                        // Tinggi garis = centerDistance / 2
                        const lineHeight = centerDistance / 2;
                        matchDiv.style.setProperty('--line-height', `${lineHeight + 1}px`); // +1 biar overlap dikit

                        if (mIndex % 2 === 0) matchDiv.classList.add('connect-down');
                        else matchDiv.classList.add('connect-up');
                    }

                    // --- ISI KONTEN ---
                    const isP1Win = match.winner === match.p1 && match.winner && match.winner !== "TBA";
                    const isP2Win = match.winner === match.p2 && match.winner && match.winner !== "TBA";

                    matchDiv.innerHTML = `
                        <div class="team ${isP1Win ? 'winner-row winner' : ''}">
                            <span class="team-name">${match.p1}</span>
                            <span class="team-score">${match.s1}</span>
                        </div>
                        <div style="border-top:1px solid #333; opacity:0.5"></div>
                        <div class="team ${isP2Win ? 'winner-row winner' : ''}">
                            <span class="team-name">${match.p2}</span>
                            <span class="team-score">${match.s2}</span>
                        </div>
                    `;
                    roundDiv.appendChild(matchDiv);
                });
                container.appendChild(roundDiv);
            });

            // CHAMPION BOX
            const finalRound = data.rounds[data.rounds.length - 1][0];
            if(finalRound.winner) {
                const champDiv = document.createElement('div');
                champDiv.className = 'round';
                champDiv.style.justifyContent = 'center';
                champDiv.style.marginLeft = '-20px'; // Dekatkan dikit
                
                // Hitung posisi vertikal Champion agar pas di tengah Final
                // Final ada di tengah container karena Flexbox, jadi Champion tinggal center aja
                
                champDiv.innerHTML = `
                    <div class="round-title text-[#00f3ff] border-none mb-2"><i class="fas fa-trophy"></i></div>
                    <div class="p-4 border border-[#00f3ff] bg-[#1a1a1a] rounded text-center shadow-[0_0_15px_rgba(0,243,255,0.2)]">
                        <span class="text-xl font-bold text-white tracking-widest">${finalRound.winner}</span>
                    </div>
                `;
                container.appendChild(champDiv);
            }
        }

        // --- DATA & SCORE LOGIC ---
        function generateAndSave() {
            const count = parseInt(document.getElementById('teamCount').value);
            const rawNames = document.getElementById('teamNamesInput').value.trim().split('\n');
            let teams = rawNames.filter(n => n.trim() !== "");
            while(teams.length < count) teams.push(`Slot ${teams.length + 1}`);
            teams = teams.slice(0, count);
            teams.sort(() => Math.random() - 0.5); 

            let structure = [];
            let matchIdCounter = 1;
            let totalRounds = Math.log2(count);

            // R1
            let round1 = [];
            for (let i = 0; i < count; i += 2) {
                round1.push({ id: matchIdCounter++, p1: teams[i], p2: teams[i+1], s1: 0, s2: 0, winner: null });
            }
            structure.push(round1);

            // Next Rounds
            for (let r = 1; r < totalRounds; r++) {
                let prevRound = structure[r-1];
                let currentRound = [];
                for(let i = 0; i < prevRound.length; i += 2) {
                    currentRound.push({ id: matchIdCounter++, p1: "TBA", p2: "TBA", s1: 0, s2: 0, winner: null });
                }
                structure.push(currentRound);
            }
            window.saveTournament({ rounds: structure });
            closeModal('setupModal');
        }

        function openScoreModal(rIdx, mIdx) {
            const match = localData.rounds[rIdx][mIdx];
            if(match.p1 === "TBA" || match.p2 === "TBA") { alert("Match not ready"); return; }
            selectedRoundIdx = rIdx; selectedMatchIdx = mIdx;
            
            document.querySelector('.match-id-display').innerText = `${match.p1} vs ${match.p2}`;
            document.getElementById('scoreTeamA').innerText = match.p1;
            document.getElementById('scoreTeamB').innerText = match.p2;
            document.getElementById('inputScoreA').value = match.s1;
            document.getElementById('inputScoreB').value = match.s2;
            document.getElementById('scoreModal').classList.remove('hidden');
        }

        function submitScore() {
            const rounds = JSON.parse(JSON.stringify(localData.rounds)); 
            const match = rounds[selectedRoundIdx][selectedMatchIdx];
            const s1 = parseInt(document.getElementById('inputScoreA').value);
            const s2 = parseInt(document.getElementById('inputScoreB').value);

            match.s1 = s1; match.s2 = s2;
            if (s1 > s2) match.winner = match.p1;
            else if (s2 > s1) match.winner = match.p2;
            else match.winner = null;

            const nextR = selectedRoundIdx + 1;
            if (match.winner && nextR < rounds.length) {
                const nextM = Math.floor(selectedMatchIdx / 2);
                const isTop = (selectedMatchIdx % 2 === 0);
                if(isTop) rounds[nextR][nextM].p1 = match.winner;
                else rounds[nextR][nextM].p2 = match.winner;
                
                // Reset next match result
                rounds[nextR][nextM].winner = null;
                rounds[nextR][nextM].s1 = 0;
                rounds[nextR][nextM].s2 = 0;
            }
            window.saveTournament({ rounds: rounds });
            closeModal('scoreModal');
        }

        function openSetupModal() { document.getElementById('setupModal').classList.remove('hidden'); }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
    </script>
</body>
</html>
