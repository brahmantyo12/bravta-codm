<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bravta12 - Live Bracket</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // CONFIG FIREBASE MILIKMU
        const firebaseConfig = {
            apiKey: "AIzaSyCb71qnIjcHA9hBe20AHhQIX4xGlzgYk_Q",
            authDomain: "bravta-tournament.firebaseapp.com",
            databaseURL: "https://bravta-tournament-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "bravta-tournament",
            storageBucket: "bravta-tournament.firebasestorage.app",
            messagingSenderId: "215927889474",
            appId: "1:215927889474:web:d8e898e1f6ec08c95597db"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        window.saveTournament = (data) => set(ref(db, 'currentTournament'), data);
        
        onValue(ref(db, 'currentTournament'), (snapshot) => {
            const data = snapshot.val();
            if (data) {
                window.loadFromFirebase(data);
            } else {
                console.log("Belum ada data turnamen aktif.");
            }
        });
    </script>

    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>

    <style>
        :root {
            --ice-cyan: #00f3ff;
            --deep-blue: #0056b3;
            --bg-dark: #02060f;
            --match-bg: #0f172a;
            --line-color: #475569;
        }

        body {
            background-color: var(--bg-dark);
            background-image: radial-gradient(circle at center, #0a192f 0%, var(--bg-dark) 100%);
            color: var(--ice-cyan);
            font-family: 'Rajdhani', sans-serif;
            min-height: 100vh;
            display: flex; flex-direction: column;
        }

        /* --- Scrollbar --- */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #02060f; }
        ::-webkit-scrollbar-thumb { background: #0056b3; border-radius: 4px; }

        /* --- BRACKET LAYOUT --- */
        .tournament-container { 
            display: flex; 
            padding: 50px 20px;
            margin: 0 auto;
        }
        
        .round { 
            display: flex; 
            flex-direction: column; 
            justify-content: space-around; /* Menyebarkan pair secara merata */
            width: 270px; 
            margin-right: 50px; /* Jarak antar kolom ronde */
        }
        
        .round-title { 
            text-align: center; color: #fff; margin-bottom: 25px; font-weight: bold; 
            border-bottom: 2px solid var(--ice-cyan); letter-spacing: 2px; padding-bottom: 5px;
            text-transform: uppercase;
        }

        /* --- MATCH PAIR WRAPPER (KUNCI KERAPIHAN GARIS) --- */
        .match-pair {
            display: flex;
            flex-direction: column;
            justify-content: center;
            position: relative;
            margin-bottom: 30px; /* Jarak antar grup pertandingan */
        }

        /* Connector Siku (Bracket Shape ] ) */
        .match-pair.has-connector::after {
            content: '';
            position: absolute;
            top: 45px;    /* Titik tengah Match Atas (Estimasi tinggi match 90px / 2) */
            bottom: 45px; /* Titik tengah Match Bawah */
            right: -25px; /* Geser ke kanan luar box */
            width: 25px;
            border-right: 2px solid var(--line-color);
            border-top: 2px solid var(--line-color);
            border-bottom: 2px solid var(--line-color);
            z-index: 0;
        }

        /* Connector Garis Lurus ke Ronde Berikutnya */
        .match-pair.has-connector::before {
            content: '';
            position: absolute;
            top: 50%;
            right: -50px; /* Panjang garis ke ronde sebelah */
            width: 25px;
            height: 2px;
            background: var(--line-color);
            z-index: 0;
        }
        
        /* --- MATCH CARD --- */
        .match {
            background-color: var(--match-bg);
            border: 1px solid var(--line-color);
            border-radius: 6px; 
            padding: 8px; 
            position: relative; 
            margin: 10px 0; /* Jarak vertikal antar kotak dalam satu pair */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
            z-index: 10; /* Agar kotak ada di atas garis */
            height: 70px; /* FIXED HEIGHT agar kalkulasi garis presisi */
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .match.clickable:hover { 
            border-color: var(--ice-cyan); cursor: pointer; 
            box-shadow: 0 0 15px rgba(0, 243, 255, 0.2); 
        }

        .team { display: flex; justify-content: space-between; align-items: center; padding: 2px 6px; }
        .team-name { font-weight: 600; color: #94a3b8; max-width: 170px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .team-score { font-family: monospace; font-size: 1.1rem; color: #fbbf24; font-weight: bold; background: rgba(0,0,0,0.4); padding: 0 8px; border-radius: 3px; min-width: 30px; text-align: center; }

        .winner .team-name { color: var(--ice-cyan); text-shadow: 0 0 8px rgba(0,243,255,0.6); }
        .winner-row { background: linear-gradient(90deg, rgba(0,243,255,0.1), transparent); border-left: 2px solid var(--ice-cyan); }

        /* Khusus Final & Champion */
        .round.final-round .match { margin: auto; } /* Center vertical */
        
        .cyber-btn {
            background: linear-gradient(90deg, rgba(0,243,255,0.1), rgba(0,86,179,0.2)); color: #fff; border: 1px solid rgba(0,243,255,0.3);
            padding: 8px 16px; border-radius: 4px; text-transform: uppercase; font-weight: bold; transition: 0.3s;
        }
        .cyber-btn:hover { background: rgba(0,243,255,0.2); border-color: var(--ice-cyan); }
        .modal-bg { background: rgba(0,0,0,0.85); backdrop-filter: blur(5px); }
        .admin-only { display: none !important; }

    </style>
</head>
<body class="p-4">

    <div class="max-w-7xl mx-auto mb-6 w-full">
        <div class="flex flex-col md:flex-row justify-between items-center gap-4 bg-[#02060f] p-4 rounded-xl border border-gray-800 shadow-lg relative z-20">
            <div>
                <h1 class="text-3xl font-bold text-white uppercase tracking-widest text-shadow-glow">LIVE <span class="text-[#00f3ff]">BRACKET</span></h1>
                <div class="flex items-center gap-2 mt-1">
                    <div class="w-2 h-2 bg-red-500 rounded-full animate-pulse"></div>
                    <p class="text-xs text-gray-400 tracking-wider">REAL-TIME CONNECTED</p>
                </div>
            </div>
            
            <div class="flex gap-2">
                <div id="adminControls" class="admin-only flex gap-2">
                    <button onclick="openSetupModal()" class="cyber-btn border-yellow-500/50 text-yellow-400 hover:text-white"><i class="fas fa-tools mr-2"></i> SETUP</button>
                </div>
                <button onclick="enableAdminMode()" id="btnAdminLogin" class="cyber-btn border-gray-600 text-gray-300 hover:text-white"><i class="fas fa-lock mr-2"></i> ADMIN</button>
            </div>
        </div>
    </div>

    <div class="flex-grow overflow-auto custom-scrollbar w-full border border-gray-800 rounded-xl bg-[#050b14] relative">
        <div class="absolute inset-0 opacity-10 pointer-events-none" style="background-image: linear-gradient(#1e293b 1px, transparent 1px), linear-gradient(to right, #1e293b 1px, transparent 1px); background-size: 40px 40px;"></div>

        <div id="bracketContainer" class="tournament-container min-w-max min-h-[600px] flex items-center justify-center">
            <div class="text-center relative z-10">
                <i class="fas fa-satellite-dish text-4xl text-gray-700 mb-4 animate-bounce"></i>
                <p class="text-gray-500 font-mono">Waiting for Tournament Data...</p>
            </div>
        </div>
    </div>

    <div id="setupModal" class="fixed inset-0 modal-bg hidden z-50 flex items-center justify-center p-4">
        <div class="bg-[#0f172a] border border-[#00f3ff] p-6 rounded-xl w-full max-w-md shadow-[0_0_50px_rgba(0,243,255,0.1)]">
            <h2 class="text-xl font-bold text-white mb-4 border-b border-gray-700 pb-2">SETUP NEW TOURNAMENT</h2>
            <p class="text-xs text-red-400 mb-4 bg-red-900/20 p-2 rounded border border-red-900/50">⚠️ Warning: Data turnamen lama akan terhapus!</p>
            
            <label class="block text-sm text-[#00f3ff] mb-2 font-bold">Jumlah Tim:</label>
            <select id="teamCount" class="w-full bg-black text-white border border-gray-600 rounded p-3 mb-4 focus:border-[#00f3ff] outline-none">
                <option value="4">4 Tim (Semi Final)</option>
                <option value="8" selected>8 Tim (Quarter Final)</option>
                <option value="16">16 Tim (Round of 16)</option>
            </select>

            <label class="block text-sm text-[#00f3ff] mb-2 font-bold">Nama Tim (1 per baris):</label>
            <textarea id="teamNamesInput" rows="6" class="w-full bg-black text-white border border-gray-600 rounded p-3 text-sm focus:border-[#00f3ff] outline-none" placeholder="Team Alpha&#10;Team Bravo&#10;Team Charlie..."></textarea>
            
            <div class="flex justify-end gap-3 mt-6">
                <button onclick="closeModal('setupModal')" class="px-4 text-gray-400 hover:text-white transition">Cancel</button>
                <button onclick="generateAndSave()" class="cyber-btn bg-red-600/20 border-red-500 hover:bg-red-600 hover:border-red-400">CREATE NEW</button>
            </div>
        </div>
    </div>

    <div id="scoreModal" class="fixed inset-0 modal-bg hidden z-50 flex items-center justify-center p-4">
        <div class="bg-[#0f172a] border border-orange-500 p-6 rounded-xl w-full max-w-sm shadow-[0_0_50px_rgba(249,115,22,0.15)]">
            <h2 class="text-xl font-bold text-white mb-1">UPDATE MATCH</h2>
            <p class="text-xs text-gray-500 mb-6 match-id-display tracking-widest uppercase">MATCH DETAILS</p>

            <div class="flex justify-between items-center mb-4 bg-black/40 p-3 rounded border border-gray-800">
                <span id="scoreTeamA" class="font-bold text-white text-lg truncate w-32">Team A</span>
                <input type="number" id="inputScoreA" class="w-16 bg-[#02060f] border border-gray-600 text-center text-yellow-400 font-bold text-xl rounded p-1 focus:border-yellow-400 outline-none" value="0">
            </div>

            <div class="flex justify-center text-gray-600 text-xs font-bold mb-4">- VS -</div>

            <div class="flex justify-between items-center mb-8 bg-black/40 p-3 rounded border border-gray-800">
                <span id="scoreTeamB" class="font-bold text-white text-lg truncate w-32">Team B</span>
                <input type="number" id="inputScoreB" class="w-16 bg-[#02060f] border border-gray-600 text-center text-yellow-400 font-bold text-xl rounded p-1 focus:border-yellow-400 outline-none" value="0">
            </div>

            <div class="flex flex-col gap-3">
                <button onclick="submitScore()" class="cyber-btn w-full bg-green-900/20 text-green-400 border-green-500 hover:bg-green-600 hover:text-white">
                    <i class="fas fa-check mr-2"></i> UPDATE SCORE
                </button>
                <button onclick="closeModal('scoreModal')" class="text-gray-500 text-sm hover:text-white transition">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // --- GLOBAL VARIABLES ---
        let localData = null;
        let isAdmin = false;
        let selectedRoundIdx = -1;
        let selectedMatchIdx = -1;

        // --- ADMIN AUTH ---
        function enableAdminMode() {
            const pass = prompt("Enter Admin Password:");
            if(pass === "admin123") { 
                isAdmin = true;
                document.getElementById('adminControls').classList.remove('admin-only');
                document.getElementById('btnAdminLogin').classList.add('hidden');
                if(localData) renderBracket(localData);
                alert("Admin Mode Active.");
            } else {
                alert("Wrong Password");
            }
        }

        // --- FIREBASE SYNC ---
        window.loadFromFirebase = (data) => {
            localData = data;
            renderBracket(data);
        };

        // --- GENERATOR LOGIC ---
        function generateAndSave() {
            const count = parseInt(document.getElementById('teamCount').value);
            const rawNames = document.getElementById('teamNamesInput').value.trim().split('\n');
            let teams = rawNames.filter(n => n.trim() !== "");
            
            while(teams.length < count) teams.push(`Slot ${teams.length + 1}`);
            teams = teams.slice(0, count);
            teams.sort(() => Math.random() - 0.5); 

            let structure = [];
            let matchIdCounter = 0;
            let totalRounds = Math.log2(count);

            // Create Round 1
            let round1 = [];
            for (let i = 0; i < count; i += 2) {
                round1.push({
                    id: matchIdCounter++, p1: teams[i], p2: teams[i+1], s1: 0, s2: 0, winner: null
                });
            }
            structure.push(round1);

            // Create Next Rounds
            for (let r = 1; r < totalRounds; r++) {
                let prevRound = structure[r-1];
                let currentRound = [];
                let matchesInPrev = prevRound.length;
                
                // Jumlah match di ronde ini adalah setengah dari ronde sebelumnya
                for(let i = 0; i < matchesInPrev; i += 2) {
                    currentRound.push({
                        id: matchIdCounter++, p1: "TBA", p2: "TBA", s1: 0, s2: 0, winner: null,
                    });
                }
                structure.push(currentRound);
            }

            window.saveTournament({ rounds: structure });
            closeModal('setupModal');
        }

        // --- RENDER LOGIC (WITH PAIR GROUPING) ---
        function renderBracket(data) {
            const container = document.getElementById('bracketContainer');
            container.innerHTML = '';
            
            if(!data || !data.rounds) return;

            const roundNames = ["Round of 16", "Quarter Final", "Semi Final", "Grand Final", "Champion"];
            let startIndex = roundNames.length - data.rounds.length - 1;

            data.rounds.forEach((round, rIndex) => {
                const roundDiv = document.createElement('div');
                const isFinalRound = rIndex === data.rounds.length - 1;
                
                roundDiv.className = `round ${isFinalRound ? 'final-round' : ''}`;
                
                const title = document.createElement('div');
                title.className = 'round-title';
                title.innerText = roundNames[startIndex + rIndex] || `Round ${rIndex+1}`;
                roundDiv.appendChild(title);

                // --- NEW LOGIC: GROUP BY PAIRS ---
                if (!isFinalRound) {
                    // Untuk ronde biasa, kita group per 2 match (Pair)
                    for(let i = 0; i < round.length; i += 2) {
                        const pairDiv = document.createElement('div');
                        pairDiv.className = 'match-pair has-connector'; // Punya garis penghubung

                        // Match 1 (Top)
                        pairDiv.appendChild(createMatchDiv(round[i], rIndex, i));
                        
                        // Match 2 (Bottom)
                        if (round[i+1]) {
                            pairDiv.appendChild(createMatchDiv(round[i+1], rIndex, i+1));
                        }

                        roundDiv.appendChild(pairDiv);
                    }
                } else {
                    // Untuk Grand Final (Hanya 1 match, tidak perlu pair wrapper connector)
                    roundDiv.appendChild(createMatchDiv(round[0], rIndex, 0));
                }

                container.appendChild(roundDiv);
            });

            // Champion Display
            const finalRound = data.rounds[data.rounds.length - 1][0];
            if(finalRound.winner) {
                renderChampion(container, finalRound.winner);
            }
        }

        // Helper function to create Match HTML
        function createMatchDiv(match, rIndex, mIndex) {
            const matchDiv = document.createElement('div');
            let cursorClass = "cursor-default";
            if(isAdmin) {
                cursorClass = "clickable";
                matchDiv.onclick = () => openScoreModal(rIndex, mIndex);
            }
            matchDiv.className = `match ${cursorClass}`;

            const isP1Win = match.winner === match.p1 && match.winner !== "TBA" && match.winner !== null;
            const isP2Win = match.winner === match.p2 && match.winner !== "TBA" && match.winner !== null;

            matchDiv.innerHTML = `
                <div class="team ${isP1Win ? 'winner-row winner' : ''}">
                    <span class="team-name">${match.p1}</span>
                    <span class="team-score">${match.s1}</span>
                </div>
                <div class="border-t border-gray-800 my-1"></div>
                <div class="team ${isP2Win ? 'winner-row winner' : ''}">
                    <span class="team-name">${match.p2}</span>
                    <span class="team-score">${match.s2}</span>
                </div>
            `;
            return matchDiv;
        }

        function renderChampion(container, winnerName) {
            const champDiv = document.createElement('div');
            champDiv.className = 'round justify-center ml-10'; // Tambah margin kiri
            champDiv.style.width = '240px';
            champDiv.innerHTML = `
                <div class="round-title text-yellow-400"><i class="fas fa-crown"></i> CHAMPION</div>
                <div class="p-6 border-2 border-yellow-500 rounded-xl bg-gradient-to-b from-yellow-900/50 to-black text-center shadow-[0_0_30px_rgba(234,179,8,0.4)] relative overflow-hidden transform scale-110">
                    <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/carbon-fibre.png')] opacity-20"></div>
                    <span class="text-2xl font-bold text-white uppercase tracking-widest relative z-10">${winnerName}</span>
                </div>
            `;
            container.appendChild(champDiv);
        }

        // --- SCORING LOGIC ---
        function openScoreModal(rIdx, mIdx) {
            const match = localData.rounds[rIdx][mIdx];
            if(match.p1 === "TBA" || match.p2 === "TBA") {
                alert("Match belum siap!"); return;
            }
            selectedRoundIdx = rIdx; selectedMatchIdx = mIdx;
            document.querySelector('.match-id-display').innerText = `${match.p1} vs ${match.p2}`;
            document.getElementById('scoreTeamA').innerText = match.p1;
            document.getElementById('scoreTeamB').innerText = match.p2;
            document.getElementById('inputScoreA').value = match.s1;
            document.getElementById('inputScoreB').value = match.s2;
            document.getElementById('scoreModal').classList.remove('hidden');
        }

        function submitScore() {
            const rIdx = selectedRoundIdx;
            const mIdx = selectedMatchIdx;
            const rounds = JSON.parse(JSON.stringify(localData.rounds)); 
            const match = rounds[rIdx][mIdx];
            const s1 = parseInt(document.getElementById('inputScoreA').value);
            const s2 = parseInt(document.getElementById('inputScoreB').value);

            match.s1 = s1; match.s2 = s2;
            if (s1 > s2) match.winner = match.p1;
            else if (s2 > s1) match.winner = match.p2;
            else match.winner = null;

            const nextRIdx = rIdx + 1;
            if (match.winner && nextRIdx < rounds.length) {
                const nextMIdx = Math.floor(mIdx / 2);
                const isTopSlot = (mIdx % 2 === 0);
                if(isTopSlot) rounds[nextRIdx][nextMIdx].p1 = match.winner;
                else rounds[nextRIdx][nextMIdx].p2 = match.winner;
                
                rounds[nextRIdx][nextMIdx].winner = null;
                rounds[nextRIdx][nextMIdx].s1 = 0;
                rounds[nextRIdx][nextMIdx].s2 = 0;
            }
            window.saveTournament({ rounds: rounds });
            closeModal('scoreModal');
        }

        function openSetupModal() { document.getElementById('setupModal').classList.remove('hidden'); }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
    </script>
</body>
</html>
