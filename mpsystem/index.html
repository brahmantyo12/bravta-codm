<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bravta12 - Live Bracket</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // CONFIG FIREBASE (JANGAN DIUBAH)
        const firebaseConfig = {
            apiKey: "AIzaSyCb71qnIjcHA9hBe20AHhQIX4xGlzgYk_Q",
            authDomain: "bravta-tournament.firebaseapp.com",
            databaseURL: "https://bravta-tournament-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "bravta-tournament",
            storageBucket: "bravta-tournament.firebasestorage.app",
            messagingSenderId: "215927889474",
            appId: "1:215927889474:web:d8e898e1f6ec08c95597db"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        window.saveTournament = (data) => set(ref(db, 'currentTournament'), data);
        
        onValue(ref(db, 'currentTournament'), (snapshot) => {
            const data = snapshot.val();
            if (data) window.loadFromFirebase(data);
        });
    </script>

    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>

    <style>
        :root {
            --ice-cyan: #00f3ff;
            --bg-dark: #02060f;
            --match-bg: #0f172a;
            --line-color: #475569;
            --card-height: 64px; /* Tinggi pasti setiap kotak match */
        }

        body {
            background-color: var(--bg-dark);
            background-image: radial-gradient(circle at center, #0a192f 0%, var(--bg-dark) 100%);
            color: var(--ice-cyan);
            font-family: 'Rajdhani', sans-serif;
            min-height: 100vh;
            display: flex; flex-direction: column; overflow: hidden;
        }

        /* --- LAYOUT UTAMA --- */
        .bracket-wrapper {
            flex-grow: 1;
            overflow: auto;
            display: flex;
            align-items: center; /* Center Vertikal */
            padding: 40px;
            position: relative;
        }
        
        .tournament-tree {
            display: flex;
            flex-direction: row;
            margin: auto; /* Center Horizontal */
        }

        .round {
            display: flex;
            flex-direction: column;
            justify-content: space-around; /* Kunci agar jarak match merata */
            margin-right: 60px; /* Jarak antar ronde */
            min-width: 260px;
        }

        .round-title {
            text-align: center; color: white; margin-bottom: 20px;
            font-weight: bold; text-transform: uppercase; letter-spacing: 2px;
            border-bottom: 2px solid var(--ice-cyan); padding-bottom: 5px;
        }

        /* --- MATCH PAIR (WADAH 2 MATCH) --- */
        /* Ini adalah kunci perbaikan garisnya */
        .match-pair {
            display: flex;
            flex-direction: column;
            justify-content: center;
            position: relative;
            /* Margin dinamis akan diatur oleh flex-grow parent */
        }

        /* --- GARIS PENGHUBUNG (Siku ] ) --- */
        /* Kita gambar garis di wadah pair, bukan di match-nya */
        .match-pair.connected::after {
            content: '';
            position: absolute;
            right: -30px; /* Geser ke kanan ronde */
            width: 30px;
            border-right: 2px solid var(--line-color);
            /* Kalkulasi Siku: Mulai dari tengah Match Atas s.d. Tengah Match Bawah */
            top: calc(var(--card-height) / 2); 
            bottom: calc(var(--card-height) / 2);
            /* Garis Horizontal Atas & Bawah */
            border-top: 2px solid var(--line-color);
            border-bottom: 2px solid var(--line-color);
            z-index: 0;
        }

        /* Garis Keluar menuju ronde berikutnya */
        .match-pair.connected::before {
            content: '';
            position: absolute;
            right: -60px; /* Nyambung ke ronde sebelah */
            top: 50%;
            width: 30px;
            height: 2px;
            background: var(--line-color);
            z-index: 0;
        }

        /* --- MATCH CARD --- */
        .match {
            background-color: var(--match-bg);
            border: 1px solid var(--line-color);
            border-radius: 6px;
            padding: 0 10px;
            margin: 10px 0; /* Jarak antar kotak dalam 1 pair */
            height: var(--card-height); /* Tinggi FIX */
            display: flex;
            flex-direction: column;
            justify-content: center;
            position: relative;
            z-index: 10;
            transition: all 0.2s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.5);
        }

        .match.clickable:hover {
            border-color: var(--ice-cyan);
            cursor: pointer;
            box-shadow: 0 0 15px rgba(0, 243, 255, 0.3);
            transform: scale(1.02);
        }

        .team { display: flex; justify-content: space-between; align-items: center; font-size: 0.9rem; }
        .team-name { font-weight: 600; color: #94a3b8; max-width: 160px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .team-score { font-family: monospace; font-weight: bold; color: #fbbf24; background: rgba(0,0,0,0.4); padding: 0 6px; border-radius: 3px; min-width: 25px; text-align: center; }

        .winner .team-name { color: var(--ice-cyan); text-shadow: 0 0 5px var(--ice-cyan); }
        .winner-row { background: linear-gradient(90deg, rgba(0,243,255,0.1), transparent); border-left: 2px solid var(--ice-cyan); }

        /* Khusus Final Round */
        .final-round .match { margin: auto; } /* Center vertical */
        
        /* UI Components */
        .cyber-btn {
            background: linear-gradient(90deg, rgba(0,243,255,0.1), rgba(0,86,179,0.2)); color: #fff; border: 1px solid rgba(0,243,255,0.3);
            padding: 8px 16px; border-radius: 4px; text-transform: uppercase; font-weight: bold; transition: 0.3s;
        }
        .cyber-btn:hover { background: rgba(0,243,255,0.2); border-color: var(--ice-cyan); }
        .modal-bg { background: rgba(0,0,0,0.9); backdrop-filter: blur(5px); }
        .admin-only { display: none !important; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #02060f; }
        ::-webkit-scrollbar-thumb { background: #0056b3; border-radius: 4px; }

    </style>
</head>
<body class="p-4">

    <div class="max-w-7xl mx-auto w-full z-20 relative">
        <div class="flex flex-col md:flex-row justify-between items-center gap-4 bg-[#02060f] p-4 rounded-xl border border-gray-800 shadow-lg">
            <div>
                <h1 class="text-3xl font-bold text-white uppercase tracking-widest">LIVE <span class="text-[#00f3ff]">BRACKET</span></h1>
                <div class="flex items-center gap-2 mt-1">
                    <div class="w-2 h-2 bg-red-500 rounded-full animate-pulse"></div>
                    <p class="text-xs text-gray-400 tracking-wider">REAL-TIME CONNECTED</p>
                </div>
            </div>
            <div class="flex gap-2">
                <div id="adminControls" class="admin-only flex gap-2">
                    <button onclick="openSetupModal()" class="cyber-btn border-yellow-500/50 text-yellow-400 hover:text-white"><i class="fas fa-tools mr-2"></i> SETUP</button>
                </div>
                <button onclick="enableAdminMode()" id="btnAdminLogin" class="cyber-btn border-gray-600 text-gray-300 hover:text-white"><i class="fas fa-lock mr-2"></i> ADMIN</button>
            </div>
        </div>
    </div>

    <div class="bracket-wrapper custom-scrollbar">
        <div class="absolute inset-0 opacity-10 pointer-events-none" style="background-image: linear-gradient(#1e293b 1px, transparent 1px), linear-gradient(to right, #1e293b 1px, transparent 1px); background-size: 40px 40px;"></div>

        <div id="bracketContainer" class="tournament-tree">
            <div class="text-center relative z-10 m-auto">
                <i class="fas fa-satellite-dish text-4xl text-gray-700 mb-4 animate-bounce"></i>
                <p class="text-gray-500 font-mono">Waiting for Tournament Data...</p>
            </div>
        </div>
    </div>

    <div id="setupModal" class="fixed inset-0 modal-bg hidden z-50 flex items-center justify-center p-4">
        <div class="bg-[#0f172a] border border-[#00f3ff] p-6 rounded-xl w-full max-w-md shadow-[0_0_50px_rgba(0,243,255,0.1)]">
            <h2 class="text-xl font-bold text-white mb-4 border-b border-gray-700 pb-2">SETUP TOURNAMENT</h2>
            <p class="text-xs text-red-400 mb-4 bg-red-900/20 p-2 rounded">⚠️ Data lama akan terhapus!</p>
            
            <label class="block text-sm text-[#00f3ff] mb-2 font-bold">Jumlah Tim:</label>
            <select id="teamCount" class="w-full bg-black text-white border border-gray-600 rounded p-3 mb-4 focus:border-[#00f3ff] outline-none">
                <option value="4">4 Tim</option>
                <option value="8" selected>8 Tim</option>
                <option value="16">16 Tim</option>
            </select>

            <label class="block text-sm text-[#00f3ff] mb-2 font-bold">Nama Tim (1 per baris):</label>
            <textarea id="teamNamesInput" rows="6" class="w-full bg-black text-white border border-gray-600 rounded p-3 text-sm focus:border-[#00f3ff] outline-none" placeholder="Team A&#10;Team B..."></textarea>
            
            <div class="flex justify-end gap-3 mt-6">
                <button onclick="closeModal('setupModal')" class="px-4 text-gray-400 hover:text-white">Cancel</button>
                <button onclick="generateAndSave()" class="cyber-btn bg-red-600/20 border-red-500">CREATE</button>
            </div>
        </div>
    </div>

    <div id="scoreModal" class="fixed inset-0 modal-bg hidden z-50 flex items-center justify-center p-4">
        <div class="bg-[#0f172a] border border-orange-500 p-6 rounded-xl w-full max-w-sm shadow-[0_0_50px_rgba(249,115,22,0.15)]">
            <h2 class="text-xl font-bold text-white mb-1">UPDATE MATCH</h2>
            <p class="text-xs text-gray-500 mb-6 match-id-display tracking-widest uppercase">MATCH DETAILS</p>

            <div class="flex justify-between items-center mb-4 bg-black/40 p-3 rounded border border-gray-800">
                <span id="scoreTeamA" class="font-bold text-white text-lg truncate w-32">Team A</span>
                <input type="number" id="inputScoreA" class="w-16 bg-[#02060f] border border-gray-600 text-center text-yellow-400 font-bold text-xl rounded p-1 outline-none" value="0">
            </div>
            <div class="flex justify-center text-gray-600 text-xs font-bold mb-4">- VS -</div>
            <div class="flex justify-between items-center mb-8 bg-black/40 p-3 rounded border border-gray-800">
                <span id="scoreTeamB" class="font-bold text-white text-lg truncate w-32">Team B</span>
                <input type="number" id="inputScoreB" class="w-16 bg-[#02060f] border border-gray-600 text-center text-yellow-400 font-bold text-xl rounded p-1 outline-none" value="0">
            </div>

            <div class="flex flex-col gap-3">
                <button onclick="submitScore()" class="cyber-btn w-full bg-green-900/20 text-green-400 border-green-500"><i class="fas fa-check mr-2"></i> UPDATE</button>
                <button onclick="closeModal('scoreModal')" class="text-gray-500 text-sm">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        let localData = null;
        let isAdmin = false;
        let selectedRoundIdx = -1;
        let selectedMatchIdx = -1;

        function enableAdminMode() {
            const pass = prompt("Enter Admin Password:");
            if(pass === "admin123") { 
                isAdmin = true;
                document.getElementById('adminControls').classList.remove('admin-only');
                document.getElementById('btnAdminLogin').classList.add('hidden');
                if(localData) renderBracket(localData);
                alert("Admin Mode Active.");
            } else { alert("Wrong Password"); }
        }

        window.loadFromFirebase = (data) => {
            localData = data;
            renderBracket(data);
        };

        function generateAndSave() {
            const count = parseInt(document.getElementById('teamCount').value);
            const rawNames = document.getElementById('teamNamesInput').value.trim().split('\n');
            let teams = rawNames.filter(n => n.trim() !== "");
            while(teams.length < count) teams.push(`Slot ${teams.length + 1}`);
            teams = teams.slice(0, count);
            teams.sort(() => Math.random() - 0.5); 

            let structure = [];
            let matchIdCounter = 0;
            let totalRounds = Math.log2(count);

            let round1 = [];
            for (let i = 0; i < count; i += 2) {
                round1.push({
                    id: matchIdCounter++, p1: teams[i], p2: teams[i+1], s1: 0, s2: 0, winner: null
                });
            }
            structure.push(round1);

            for (let r = 1; r < totalRounds; r++) {
                let prevRound = structure[r-1];
                let currentRound = [];
                for(let i = 0; i < prevRound.length; i += 2) {
                    currentRound.push({
                        id: matchIdCounter++, p1: "TBA", p2: "TBA", s1: 0, s2: 0, winner: null
                    });
                }
                structure.push(currentRound);
            }
            window.saveTournament({ rounds: structure });
            closeModal('setupModal');
        }

        // --- CORE RENDER FUNCTION (REBUILT) ---
        function renderBracket(data) {
            const container = document.getElementById('bracketContainer');
            container.innerHTML = '';
            
            if(!data || !data.rounds) return;

            const roundNames = ["Round of 16", "Quarter Final", "Semi Final", "Grand Final", "Champion"];
            let startIndex = roundNames.length - data.rounds.length - 1;

            data.rounds.forEach((round, rIndex) => {
                const roundDiv = document.createElement('div');
                const isFinalRound = rIndex === data.rounds.length - 1;
                roundDiv.className = `round ${isFinalRound ? 'final-round' : ''}`;
                
                const title = document.createElement('div');
                title.className = 'round-title';
                title.innerText = roundNames[startIndex + rIndex] || `Round ${rIndex+1}`;
                roundDiv.appendChild(title);

                // --- GROUPING LOGIC ---
                if (!isFinalRound) {
                    // Ronde Biasa: Dikelompokkan berdua (PAIR) untuk membuat garis siku
                    for(let i = 0; i < round.length; i += 2) {
                        const pairDiv = document.createElement('div');
                        pairDiv.className = 'match-pair connected'; // Tambahkan class connector

                        // Match A (Top)
                        pairDiv.appendChild(createMatchDiv(round[i], rIndex, i));
                        // Match B (Bottom)
                        if (round[i+1]) pairDiv.appendChild(createMatchDiv(round[i+1], rIndex, i+1));

                        roundDiv.appendChild(pairDiv);
                    }
                } else {
                    // Final Round: Tidak ada connector, berdiri sendiri
                    roundDiv.appendChild(createMatchDiv(round[0], rIndex, 0));
                }
                container.appendChild(roundDiv);
            });

            // Champion
            const finalRound = data.rounds[data.rounds.length - 1][0];
            if(finalRound.winner) renderChampion(container, finalRound.winner);
        }

        function createMatchDiv(match, rIndex, mIndex) {
            const matchDiv = document.createElement('div');
            matchDiv.className = `match ${isAdmin ? 'clickable' : ''}`;
            if(isAdmin) matchDiv.onclick = () => openScoreModal(rIndex, mIndex);

            const isP1Win = match.winner === match.p1 && match.winner && match.winner !== "TBA";
            const isP2Win = match.winner === match.p2 && match.winner && match.winner !== "TBA";

            matchDiv.innerHTML = `
                <div class="team ${isP1Win ? 'winner-row winner' : ''}">
                    <span class="team-name">${match.p1}</span>
                    <span class="team-score">${match.s1}</span>
                </div>
                <div class="border-t border-gray-800 my-1"></div>
                <div class="team ${isP2Win ? 'winner-row winner' : ''}">
                    <span class="team-name">${match.p2}</span>
                    <span class="team-score">${match.s2}</span>
                </div>
            `;
            return matchDiv;
        }

        function renderChampion(container, winnerName) {
            const champDiv = document.createElement('div');
            champDiv.className = 'round justify-center ml-10';
            champDiv.style.width = '240px';
            champDiv.innerHTML = `
                <div class="round-title text-yellow-400"><i class="fas fa-crown"></i> CHAMPION</div>
                <div class="p-6 border-2 border-yellow-500 rounded-xl bg-gradient-to-b from-yellow-900/50 to-black text-center shadow-[0_0_30px_rgba(234,179,8,0.4)] relative overflow-hidden transform scale-110">
                    <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/carbon-fibre.png')] opacity-20"></div>
                    <span class="text-2xl font-bold text-white uppercase tracking-widest relative z-10">${winnerName}</span>
                </div>
            `;
            container.appendChild(champDiv);
        }

        function openScoreModal(rIdx, mIdx) {
            const match = localData.rounds[rIdx][mIdx];
            if(match.p1 === "TBA" || match.p2 === "TBA") { alert("Match belum siap!"); return; }
            selectedRoundIdx = rIdx; selectedMatchIdx = mIdx;
            document.querySelector('.match-id-display').innerText = `${match.p1} vs ${match.p2}`;
            document.getElementById('scoreTeamA').innerText = match.p1;
            document.getElementById('scoreTeamB').innerText = match.p2;
            document.getElementById('inputScoreA').value = match.s1;
            document.getElementById('inputScoreB').value = match.s2;
            document.getElementById('scoreModal').classList.remove('hidden');
        }

        function submitScore() {
            const rIdx = selectedRoundIdx; const mIdx = selectedMatchIdx;
            const rounds = JSON.parse(JSON.stringify(localData.rounds)); 
            const match = rounds[rIdx][mIdx];
            const s1 = parseInt(document.getElementById('inputScoreA').value);
            const s2 = parseInt(document.getElementById('inputScoreB').value);

            match.s1 = s1; match.s2 = s2;
            if (s1 > s2) match.winner = match.p1;
            else if (s2 > s1) match.winner = match.p2;
            else match.winner = null;

            const nextRIdx = rIdx + 1;
            if (match.winner && nextRIdx < rounds.length) {
                const nextMIdx = Math.floor(mIdx / 2);
                const isTopSlot = (mIdx % 2 === 0);
                if(isTopSlot) rounds[nextRIdx][nextMIdx].p1 = match.winner;
                else rounds[nextRIdx][nextMIdx].p2 = match.winner;
                
                rounds[nextRIdx][nextMIdx].winner = null;
                rounds[nextRIdx][nextMIdx].s1 = 0;
                rounds[nextRIdx][nextMIdx].s2 = 0;
            }
            window.saveTournament({ rounds: rounds });
            closeModal('scoreModal');
        }

        function openSetupModal() { document.getElementById('setupModal').classList.remove('hidden'); }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
    </script>
</body>
</html>
